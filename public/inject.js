(function(){"use strict";const r={CHATGPT_REQUEST:"CHATGPT_REQUEST",ANONYMIZATION_RESPONSE:"ANONYMIZATION_RESPONSE"};class o{originalFetch;config;requestIdCounter=0;pendingRequests=new Map;constructor(e){this.originalFetch=window.fetch,this.config=e,this.setupResponseListener()}install(){window.fetch=this.createInterceptedFetch()}uninstall(){window.fetch=this.originalFetch,this.pendingRequests.clear()}setupResponseListener(){window.addEventListener("message",e=>{if(e.data.type===r.ANONYMIZATION_RESPONSE){const{requestId:t,anonymizedBody:n}=e.data,i=this.pendingRequests.get(t);i&&(i(n),this.pendingRequests.delete(t))}})}async handleInterceptedRequest(e){const[t,n]=e,i=n?.body;if(!i||typeof i!="string")return console.warn("[FetchInterceptor] No body or non-string body, skipping"),this.originalFetch.apply(window,e);try{const s=await this.requestAnonymization(i),a={...n,body:s};return this.originalFetch.call(window,t,a)}catch(s){return console.error("[FetchInterceptor] Error during anonymization:",s),this.originalFetch.apply(window,e)}}async requestAnonymization(e){const t=this.requestIdCounter++;return new Promise(n=>{this.pendingRequests.set(t,n),window.postMessage({type:r.CHATGPT_REQUEST,requestId:t,body:e},"*"),setTimeout(()=>{this.pendingRequests.has(t)&&(console.warn(`[FetchInterceptor] Request ${t} timed out`),this.pendingRequests.delete(t),n(e))},this.config.requestTimeout)})}shouldIntercept(e){return e.includes(this.config.targetUrlPattern)}extractUrl(e){return typeof e=="string"?e:e instanceof URL?e.href:e instanceof Request?e.url:""}createInterceptedFetch(){return async(...e)=>{const[t]=e,n=this.extractUrl(t);return this.shouldIntercept(n)?this.handleInterceptedRequest(e):this.originalFetch.apply(window,e)}}}const c={targetUrlPattern:"/conversation",requestTimeout:2e3};new o(c).install()})();
