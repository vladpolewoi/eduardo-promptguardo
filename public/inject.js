(function(){"use strict";const o={CHATGPT_REQUEST:"CHATGPT_REQUEST"};class s{originalFetch;config;requestIdCounter=0;pendingRequests=new Map;constructor(t){this.originalFetch=window.fetch,this.config=t}install(){window.fetch=this.createInterceptedFetch()}uninstall(){window.fetch=this.originalFetch,this.pendingRequests.clear()}async handleInterceptedRequest(t){const[e,n]=t,i=n?.body;if(!i||typeof i!="string")return console.warn("[FetchInterceptor] No body or non-string body, skipping"),this.originalFetch.apply(window,t);try{const r=await this.requestAnonymization(i),a={...n,body:r};return this.originalFetch.call(window,e,a)}catch(r){return console.error("[FetchInterceptor] Error during anonymization:",r),this.originalFetch.apply(window,t)}}async requestAnonymization(t){const e=this.requestIdCounter++;return new Promise(n=>{this.pendingRequests.set(e,n),window.postMessage({type:o.CHATGPT_REQUEST,requestId:e,body:t},"*"),setTimeout(()=>{this.pendingRequests.has(e)&&(console.warn(`[FetchInterceptor] Request ${e} timed out`),this.pendingRequests.delete(e),n(t))},this.config.requestTimeout)})}shouldIntercept(t){return t.includes(this.config.targetUrlPattern)}extractUrl(t){return typeof t=="string"?t:t instanceof URL?t.href:t instanceof Request?t.url:""}createInterceptedFetch(){return async(...t)=>{const[e]=t,n=this.extractUrl(e);return this.shouldIntercept(n)?this.handleInterceptedRequest(t):this.originalFetch.apply(window,t)}}}console.log("[Inject] initialized");const c={targetUrlPattern:"/conversation",requestTimeout:2e3};new s(c).install()})();
